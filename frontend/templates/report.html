{% extends "base.html" %}
{% block head %}
<style>
  /* Report Container */
  .report-wrap {
    background: #ffffff;
    color: #1a1a1a;
    border-radius: 16px;
    padding: 48px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    border: 1px solid #e8e4df;
    max-width: 900px;
    margin: 0 auto;
  }

  /* Header */
  .report-header {
    display: flex;
    justify-content: space-between;
    gap: 32px;
    border-bottom: 2px solid #e8e4df;
    padding-bottom: 24px;
    margin-bottom: 32px;
    flex-wrap: wrap;
  }

  .brand {
    font-size: 20px;
    font-weight: 700;
    color: #d97756;
    letter-spacing: 0.2px;
  }

  .report-title {
    font-size: 32px;
    font-weight: 700;
    margin-top: 8px;
    color: #1a1a1a;
  }

  .report-subtitle {
    font-size: 14px;
    color: #6b6b6b;
    margin-top: 4px;
  }

  .report-meta {
    font-size: 13px;
    color: #6b6b6b;
    text-align: right;
  }

  .report-meta div {
    margin-bottom: 4px;
  }

  .report-meta span {
    display: inline-block;
    min-width: 100px;
    color: #1a1a1a;
    font-weight: 600;
  }

  /* Executive Summary Card */
  .executive-summary {
    background: linear-gradient(135deg, #fef4f1 0%, #faf9f6 100%);
    border: 1px solid #f5e6df;
    border-left: 4px solid #d97756;
    border-radius: 0 12px 12px 0;
    padding: 24px 28px;
    margin-bottom: 32px;
  }

  .executive-summary h3 {
    margin: 0 0 12px 0;
    font-size: 13px;
    color: #d97756;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 600;
  }

  .executive-summary p {
    margin: 0;
    font-size: 15px;
    line-height: 1.7;
    color: #1a1a1a;
  }

  /* Sections */
  .report-section {
    margin-bottom: 32px;
  }

  .report-section h3 {
    margin: 0 0 16px 0;
    font-size: 13px;
    color: #6b6b6b;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 600;
    padding-bottom: 8px;
    border-bottom: 1px solid #e8e4df;
  }

  /* Metric Cards Grid */
  .report-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .metric-card {
    border: 1px solid #e8e4df;
    border-radius: 12px;
    padding: 20px;
    background: #faf9f6;
  }

  .metric-card h4 {
    margin: 0 0 8px 0;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #9b9b9b;
    font-weight: 600;
  }

  .metric-card p {
    margin: 0;
    font-size: 15px;
    font-weight: 500;
    color: #1a1a1a;
  }

  /* Clinical Interpretation - Rendered Markdown */
  .clinical-interpretation {
    background: #faf9f6;
    border: 1px solid #e8e4df;
    border-radius: 12px;
    padding: 24px 28px;
  }

  .clinical-interpretation h2 {
    font-size: 18px;
    font-weight: 600;
    color: #d97756;
    margin: 24px 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #e8e4df;
  }

  .clinical-interpretation h2:first-child {
    margin-top: 0;
  }

  .clinical-interpretation p {
    font-size: 14px;
    line-height: 1.8;
    color: #1a1a1a;
    margin: 0 0 12px 0;
  }

  .clinical-interpretation ul,
  .clinical-interpretation ol {
    margin: 0 0 16px 0;
    padding-left: 24px;
  }

  .clinical-interpretation li {
    font-size: 14px;
    line-height: 1.7;
    color: #1a1a1a;
    margin-bottom: 8px;
  }

  .clinical-interpretation strong {
    color: #1a1a1a;
    font-weight: 600;
  }

  /* Citation Links */
  .citation-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #d97756;
    color: white !important;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    text-decoration: none;
    margin: 0 2px;
    transition: all 0.15s ease;
    vertical-align: super;
  }

  .citation-link:hover {
    background: #c06646;
    transform: scale(1.1);
  }

  /* Lab Table */
  .report-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .report-table th,
  .report-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #e8e4df;
    text-align: left;
  }

  .report-table th {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #9b9b9b;
    font-weight: 600;
    background: #faf9f6;
  }

  .report-table tr:hover {
    background: #faf9f6;
  }

  .flag-high {
    color: #c94a4a;
    font-weight: 700;
  }

  .flag-low {
    color: #2563eb;
    font-weight: 700;
  }

  /* Citations Section */
  .citations-section {
    background: #f5f3f0;
    border: 1px solid #e8e4df;
    border-radius: 12px;
    padding: 24px 28px;
  }

  .citation-block {
    padding: 16px 20px;
    background: white;
    border: 1px solid #e8e4df;
    border-radius: 8px;
    margin-bottom: 12px;
    scroll-margin-top: 100px;
  }

  .citation-block:target {
    border-color: #d97756;
    box-shadow: 0 0 0 3px rgba(217, 119, 86, 0.2);
  }

  .citation-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #d97756;
    color: white;
    font-size: 12px;
    font-weight: 600;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    margin-right: 12px;
  }

  .citation-text {
    font-size: 13px;
    line-height: 1.6;
    color: #4a4a4a;
    display: block;
    margin-top: 8px;
    max-height: 80px;
    overflow-y: auto;
    font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    background: #f8f8f8;
    padding: 12px;
    border-radius: 6px;
  }

  .citation-source {
    font-weight: 500;
    color: #1a1a1a;
  }

  /* Report Footer */
  .report-footer {
    border-top: 1px solid #e8e4df;
    padding-top: 16px;
    margin-top: 32px;
    font-size: 12px;
    color: #9b9b9b;
    text-align: center;
  }

  .back-link {
    margin-bottom: 16px;
  }

  .back-link a {
    color: #9b9b9b;
    font-size: 13px;
    text-decoration: none;
  }

  .back-link a:hover {
    color: #d97756;
  }

  .report-muted {
    color: #9b9b9b;
    font-style: italic;
  }

  /* Actions Row */
  .report-actions {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
  }

  .report-actions button,
  .report-actions a {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 500;
    border-radius: 8px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .btn-print {
    background: #1a1a1a;
    color: white;
    border: none;
  }

  .btn-print:hover {
    background: #333;
  }

  .btn-export {
    background: white;
    color: #1a1a1a;
    border: 1px solid #e8e4df;
  }

  .btn-export:hover {
    border-color: #d97756;
    color: #d97756;
  }

  /* Print Styles */
  @media print {

    .back-link,
    .report-actions,
    header,
    nav {
      display: none !important;
    }

    body {
      background: white !important;
    }

    .report-wrap {
      box-shadow: none !important;
      border: none !important;
      padding: 0 !important;
      max-width: 100% !important;
    }

    .citation-link {
      background: none !important;
      color: #d97756 !important;
      padding: 0 !important;
    }

    .citation-block:target {
      border-color: #e8e4df !important;
      box-shadow: none !important;
    }

    h1,
    h2,
    h3 {
      page-break-after: avoid;
    }

    table {
      page-break-inside: avoid;
    }

    .report-section {
      page-break-inside: avoid;
    }
  }

  ul,
  ol {
    margin: 0;
    padding-left: 20px;
  }

  li {
    margin-bottom: 6px;
  }
</style>
{% endblock %}

{% block content %}
<div class="back-link">
  <a href="/ui/patients/{{ patient.id }}">‚Üê Back to {{ patient.full_name }}</a>
</div>

<div class="report-actions">
  <button type="button" class="btn-print" id="printReportBtn">üñ®Ô∏è Print Report</button>
  <a href="/ui/patients/{{ patient.id }}" class="btn-export">‚Üê Edit Patient</a>
  <a href="/ui/patients/{{ patient.id }}/report/share" class="btn-export"
    style="background: #e0f2fe; border-color: #7dd3fc; color: #0369a1;">
    üë§ Share with Patient
  </a>
  {% if draft %}
  {% if draft.status == 'finalized' %}
  <span
    style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; font-size: 13px; font-weight: 600; color: #22c55e; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;">
    ‚úì Approved & Finalized
  </span>
  {% else %}
  <form method="post" action="/ui/patients/{{ patient.id }}/report/finalize" style="display: inline;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <button type="submit"
      style="background: #22c55e; color: white; border: none; padding: 10px 16px; font-size: 13px; font-weight: 500; border-radius: 8px; cursor: pointer;">
      ‚úì Approve & Finalize
    </button>
  </form>
  {% endif %}
  {% endif %}
</div>

<div class="report-wrap">
  <!-- Header -->
  <div class="report-header">
    <div>
      <div class="brand">MedCHR.ai</div>
      <div class="report-title">Client Health Report</div>
      <div class="report-subtitle">Comprehensive ‚Ä¢ Cited ‚Ä¢ Clinician-Reviewed</div>
    </div>
    <div class="report-meta">
      <div><span>Patient:</span> {{ patient.full_name }}</div>
      <div><span>DOB:</span> {{ patient.dob or "-" }}</div>
      <div><span>Report Date:</span> {{ (draft.created_at|string)[:10] if draft and draft.created_at else "Not
        generated" }}</div>
      <div><span>Prepared By:</span> {{ user }}</div>
    </div>
  </div>

  <!-- Executive Summary -->
  {% if summary_html %}
  <div class="executive-summary">
    <h3>Executive Summary</h3>
    <p>
      This report analyzes {{ documents | length }} source document(s) for patient {{ patient.full_name }}.
      {{ findings | length }} abnormal lab values were flagged.
      {% if citations %}{{ citations | length }} source citations are referenced throughout.{% endif %}
    </p>
  </div>
{% endif %}

<!-- Ask a Clinical Question (RAG Query) -->
<div class="report-section"
  style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; border-radius: 12px; padding: 24px;">
  <h3 style="color: #16a34a; margin-bottom: 16px;">üîç Ask a Clinical Question</h3>
  <form method="post" action="/ui/patients/{{ patient.id }}/report/query" style="display: flex; gap: 12px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <input type="text" name="query" value="{{ query_result.query if query_result else '' }}"
      placeholder="e.g., What are the kidney abnormalities? or Show thyroid-related findings..."
      style="flex: 1; padding: 12px 16px; border: 1px solid #bbf7d0; border-radius: 8px; font-size: 14px;" />
    <button type="submit"
      style="background: #16a34a; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer;">
      Search Documents
    </button>
  </form>

  {% if query_result %}
  <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #bbf7d0;">
    <div style="font-size: 13px; color: #6b6b6b; margin-bottom: 12px;">
      Answering: <strong>{{ query_result.query }}</strong>
    </div>
    <div class="clinical-interpretation"
      style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e8e4df;">
      {{ query_result.answer_html | safe }}
    </div>

    {% if query_result.citations %}
    <div style="margin-top: 16px;">
      <h4 style="font-size: 13px; color: #6b6b6b; margin-bottom: 12px;">Sources Retrieved:</h4>
      {% for cite in query_result.citations %}
      <div id="query-cite-{{ cite.index }}"
        style="background: #faf9f6; border: 1px solid #e8e4df; border-radius: 8px; padding: 12px; margin-bottom: 8px; font-size: 13px;">
        <span
          style="display: inline-block; background: #16a34a; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 8px;">[{{
          cite.index }}]</span>
        <span style="color: #333;">{{ cite.text[:300] }}{% if cite.text | length > 300 %}...{% endif %}</span>
        {% if cite.filename %}
        <div style="margin-top: 6px; font-size: 12px; color: #6b6b6b;">
          Source: {{ cite.filename }}{% if cite.chunk_index is not none %} ¬∑ chunk {{ cite.chunk_index }}{% endif %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Patient Snapshot -->
<div class="report-section">
  <h3>Patient Snapshot</h3>
  <div class="report-grid">
    <div class="metric-card">
      <h4>Clinical Notes</h4>
      <p>{{ patient.notes or "No notes on file." }}</p>
    </div>
    <div class="metric-card">
      <h4>Source Documents</h4>
      <p>{{ documents | length }} files uploaded</p>
    </div>
    <div class="metric-card">
      <h4>Key Findings</h4>
      <p>{{ findings | length }} flagged lab values</p>
    </div>
    <div class="metric-card">
      <h4>Citations</h4>
      <p>{{ citations | length }} source references</p>
    </div>
  </div>
</div>

<!-- Key Findings -->
<div class="report-section">
  <h3>Key Findings</h3>
  {% if findings %}
  <ul>
    {% for item in findings %}
    <li>{{ item }}</li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="report-muted">No abnormal lab flags detected in the latest extraction.</p>
  {% endif %}
</div>

<!-- Lab Summary -->
<div class="report-section">
  <h3>Lab Summary</h3>
  {% if labs %}
  <table class="report-table">
    <thead>
      <tr>
        <th>Panel</th>
        <th>Test</th>
        <th>Value</th>
        <th>Unit</th>
        <th>Reference Range</th>
        <th>Flag</th>
      </tr>
    </thead>
    <tbody>
      {% for lab in labs %}
      <tr>
        <td>{{ lab.panel or "-" }}</td>
        <td>{{ lab.test }}</td>
        <td>{{ lab.value }}</td>
        <td>{{ lab.unit }}</td>
        <td>{{ lab.range }}</td>
        <td class="{% if lab.flag == 'High' %}flag-high{% elif lab.flag == 'Low' %}flag-low{% endif %}">
          {{ lab.flag or "-" }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="report-muted">No structured labs parsed yet. Upload and process a lab report.</p>
  {% endif %}
</div>

<!-- Genetic Risk Factors (N1.care Feature) -->
<div class="report-section">
  <h3>Genetic Risk Factors</h3>
  {% if patient.genetics and patient.genetics.markers %}
  <table class="report-table">
    <thead>
      <tr>
        <th>Gene</th>
        <th>Variant</th>
        <th>Risk Level</th>
        <th>Clinical Significance</th>
      </tr>
    </thead>
    <tbody>
      {% for marker in patient.genetics.markers %}
      <tr>
        <td><strong>{{ marker.gene }}</strong></td>
        <td>{{ marker.variant }}</td>
        <td class="{% if marker.risk == 'High' %}flag-high{% elif marker.risk == 'Moderate' %}flag-low{% endif %}">
          {{ marker.risk }}
        </td>
        <td>{{ marker.significance }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="report-muted">
    No genetic data uploaded. Upload 23andMe, Ancestry, or clinical genetic reports for SNP analysis.
  </p>
  {% endif %}
</div>

<!-- Medications & Diagnoses -->
<div class="report-section report-grid">
  <div class="metric-card">
    <h4>Medications / Supplements</h4>
    {% if medications %}
    <ul style="margin-top: 8px;">
      {% for med in medications %}
      <li>{{ med }}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="report-muted">No medications extracted.</p>
    {% endif %}
  </div>
  <div class="metric-card">
    <h4>Diagnoses / Impressions</h4>
    {% if diagnoses %}
    <ul style="margin-top: 8px;">
      {% for dx in diagnoses %}
      <li>{{ dx }}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="report-muted">No diagnoses extracted.</p>
    {% endif %}
  </div>
</div>

<!-- Clinical Interpretation (Rendered Markdown) -->
<div class="report-section">
  <h3>Clinical Interpretation</h3>
  {% if edited_interpretation_html %}
  <div class="clinical-interpretation">
    {{ edited_interpretation_html | safe }}
  </div>
  {% if edited_by %}
  <p class="report-muted" style="margin-top: 8px;">Edited by {{ edited_by }}</p>
  {% endif %}
  {% if summary_html %}
  <details style="margin-top: 12px;">
    <summary class="report-muted">View AI Draft</summary>
    <div class="clinical-interpretation" style="margin-top: 8px;">
      {{ summary_html | safe }}
    </div>
  </details>
  {% endif %}
  {% elif summary_html %}
  <div class="clinical-interpretation">
    {{ summary_html | safe }}
  </div>
  {% else %}
  <p class="report-muted">Generate a CHR draft to populate this section.</p>
  {% endif %}
</div>

<!-- Source Documents -->
<div class="report-section">
  <h3>Source Documents</h3>
  {% if documents %}
  <ul>
    {% for doc in documents %}
    <li><strong>{{ doc.filename }}</strong> <span class="report-muted">({{ doc.content_type }})</span></li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="report-muted">No documents uploaded.</p>
  {% endif %}
</div>

<!-- Citations (RAG) -->
<div class="report-section">
  <h3>Citations</h3>
  {% if citations %}
  <div class="citations-section">
    <p style="font-size: 13px; color: #6b6b6b; margin-bottom: 16px;">
      Click any <span class="citation-link" style="cursor: default;">#</span> citation in the Clinical Interpretation
      above to jump to its source below.
    </p>
    {% for cite in citations %}
    <div id="cite-{{ cite.index }}" class="citation-block">
      <span class="citation-number">{{ cite.index }}</span>
      <span class="citation-source">Source Document Excerpt</span>
      <span class="citation-text">{{ cite.text[:500] }}{% if cite.text|length > 500 %}...{% endif %}</span>
      {% if cite.filename %}
      <div class="report-muted" style="margin-top: 6px;">
        {{ cite.filename }}{% if cite.chunk_index is not none %} ¬∑ chunk {{ cite.chunk_index }}{% endif %}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="report-muted">No citations available. Generate a CHR draft with processed documents.</p>
  {% endif %}
</div>

<!-- Compliance -->
<div class="report-section">
  <h3>Compliance & Limitations</h3>
  <p class="report-muted" style="font-size: 13px; line-height: 1.6;">
    This report is generated for clinician review only. It does not constitute a diagnosis and does not
    replace professional medical judgment. All AI-generated statements should be validated against the original source
    documents. Synthetic demo data may be present.
  </p>
</div>

<!-- Footer -->
<div class="report-footer">
  MedCHR.ai ‚Ä¢ Client Health Report ‚Ä¢ Confidential ‚Ä¢ For clinician-facing review only
</div>
</div>
<script nonce="{{ csp_nonce }}">
  const printReportBtn = document.getElementById('printReportBtn');
  if (printReportBtn) {
    printReportBtn.addEventListener('click', () => window.print());
  }
</script>
{% endblock %}
