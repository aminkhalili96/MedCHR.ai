{% extends "base.html" %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
  <div>
    <h1 style="margin: 0;">Patients</h1>
    <p class="muted" style="margin: 4px 0 0 0;">Manage patient records and health reports</p>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3 class="card-title">Add New Patient</h3>
  </div>
  <form method="post" action="/ui/patients">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <div class="grid">
      <div>
        <label for="full_name">Full Name</label>
        <input type="text" id="full_name" name="full_name" placeholder="e.g., John Smith" required />
      </div>
      <div>
        <label for="dob">Date of Birth</label>
        <input type="date" id="dob" name="dob" />
      </div>
    </div>
    <div class="mt-md">
      <label for="notes">Clinical Notes</label>
      <textarea id="notes" name="notes" rows="2" placeholder="Optional notes about the patient..."></textarea>
    </div>
    <div class="mt-md">
      <button type="submit">+ Create Patient</button>
    </div>
  </form>
</div>

<div class="card">
  <div class="card-header">
    <h3 class="card-title">Patient Records</h3>
    <span class="badge badge-neutral">{{ patients | length }} patients</span>
  </div>
  {% if patients %}
  <div class="patient-grid"
    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
    {% for p in patients %}
    <a href="/ui/patients/{{ p.id }}" class="patient-card" style="
            display: block;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 20px;
            text-decoration: none;
            color: inherit;
            transition: all 0.2s ease;
          ">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 4px;">
            {{ p.full_name }}
          </div>
          <div style="font-size: 13px; color: var(--text-muted);">
            DOB: {{ p.dob or "Not specified" }}
          </div>
        </div>
        <div style="
                width: 36px;
                height: 36px;
                background: var(--accent-light);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--accent-primary);
                font-weight: 600;
                font-size: 14px;
              ">
          {{ p.full_name[0] | upper }}
        </div>
      </div>
      {% if p.notes %}
      <div style="
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid var(--border-light);
                font-size: 13px;
                color: var(--text-secondary);
                line-height: 1.5;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
              ">
        {{ p.notes }}
      </div>
      {% endif %}
    </a>
    {% endfor %}
  </div>
  <style>
    .patient-card:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
  </style>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">ðŸ“‹</div>
    <p style="font-size: 15px; color: var(--text-secondary); margin-bottom: 8px;">No patients yet</p>
    <p style="font-size: 13px; color: var(--text-muted);">Create your first patient using the form above</p>
  </div>
  {% endif %}
</div>

<script nonce="{{ csp_nonce }}">
  // Auto-format DOB input as YYYY-MM-DD
  document.getElementById('dob').addEventListener('input', function (e) {
    let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
    let formatted = '';

    if (value.length > 0) {
      formatted = value.substring(0, 4); // Year
    }
    if (value.length > 4) {
      formatted += '-' + value.substring(4, 6); // Month
    }
    if (value.length > 6) {
      formatted += '-' + value.substring(6, 8); // Day
    }

    e.target.value = formatted;
  });
</script>
{% endblock %}
