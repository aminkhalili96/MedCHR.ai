{% extends "base.html" %}
{% block content %}
<div style="margin-bottom: 16px;">
  <a href="/ui/patients/{{ patient.id }}" style="color: var(--text-muted); font-size: 13px;">‚Üê Back to {{
    patient.full_name }}</a>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
  <div>
    <h1 style="margin: 0; display: flex; align-items: center; gap: 12px;">
      RAG Top-K Viewer
      <span class="badge" style="background: var(--warning); color: white;">Developer Tool</span>
    </h1>
    <p class="muted" style="margin: 4px 0 0 0;">Patient: {{ patient.full_name }}</p>
  </div>
</div>

<div class="card" style="border: 1px dashed var(--warning); background: var(--warning-light);">
  <p style="color: var(--text-secondary); margin: 0; font-size: 13px;">
    ‚ö†Ô∏è This is a developer tool for debugging RAG retrieval. It shows the top-K most similar text chunks based on vector
    similarity.
  </p>
</div>

<div class="card">
  <div class="card-header">
    <h3 class="card-title">Query Settings</h3>
  </div>
  <form method="get" action="/ui/patients/{{ patient.id }}/rag">
    <label for="query">Query</label>
    <textarea id="query" name="q" rows="3"
      placeholder="Enter a search query (leave blank to use latest extraction)...">{{ query }}</textarea>
    <div class="row mt-md">
      <div style="flex: 0 0 120px;">
        <label for="top_k">Top K</label>
        <input type="number" id="top_k" name="k" value="{{ top_k }}" min="1" max="20" />
      </div>
      <div style="flex: 1; display: flex; align-items: flex-end;">
        <button type="submit">Retrieve Chunks</button>
      </div>
    </div>
  </form>
</div>

<div class="card">
  <div class="card-header">
    <h3 class="card-title">Retrieved Chunks</h3>
    <span class="badge badge-neutral">{{ chunks | length }} results</span>
  </div>
  {% if chunks %}
  <div style="display: flex; flex-direction: column; gap: 12px;">
    {% for chunk in chunks %}
    <div style="
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
          ">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <span class="badge badge-neutral">#{{ loop.index }}</span>
        <span style="font-size: 12px; color: var(--text-muted); font-family: monospace;">
          Distance: {{ "%.4f"|format(chunk.distance) }}
        </span>
      </div>
      <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
        {{ chunk.filename }} ¬∑ chunk {{ chunk.chunk_index if chunk.chunk_index is not none else "n/a" }}
      </div>
      <div style="
              font-size: 13px;
              color: var(--text-secondary);
              line-height: 1.6;
              white-space: pre-wrap;
              font-family: 'SF Mono', Monaco, 'Courier New', monospace;
              background: var(--bg-secondary);
              padding: 12px;
              border-radius: var(--radius-sm);
              border: 1px solid var(--border-light);
              max-height: 200px;
              overflow-y: auto;
            ">{{ chunk.chunk_text }}</div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">üîç</div>
    <p style="font-size: 14px; color: var(--text-secondary);">No chunks found</p>
    <p style="font-size: 13px; color: var(--text-muted);">Run extraction and embeddings on documents first, then try a
      query</p>
  </div>
  {% endif %}
</div>
{% endblock %}
